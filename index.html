<!DOCTYPE html>
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAVGdgOJKBUM68fUxeK7UJLfy-Ninw-CaU&sensor=true"></script>
    <script>
      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position){
            gotLocation(position.coords.latitude,position.coords.longitude)
            geocodePosition(position);
          }, function(error){
            console.log(error);
          });
        }
        else {
          console.log('not locating')
        }
      }

      function gotLocation(latitude, longitude) {
        APIKEY = 'f54e20e4a9969502845b541885b4165b'
        $.getJSON('https://api.forecast.io/forecast/f54e20e4a9969502845b541885b4165b/' + latitude + ',' + longitude + '?units=auto&callback=?', function(data){
          console.log(data)
          var units = data.flags.units == 'us' ? 'F' : 'C';
          $('#weatherSummary ul').html('');
          $('#weatherSummary ul').append('<li>' + data.currently.summary + '</li>')
          $('#weatherSummary ul').append('<li>' + data.currently.temperature + '&deg;' + units + '</li>')
          $('#weatherSummary ul').append('<li>' + data.currently.precipProbability*100 + '% chance of precipitation</li>')
          $('#weatherSummary ul').append('<li>High: ' + data.daily.data[0].temperatureMax + '&deg;' + units + '</li>')
          $('#weatherSummary ul').append('<li>Low: ' + data.daily.data[0].temperatureMin + '&deg;' + units + '</li>')
          $('#hourlyData').html('');
          $.each(data.hourly.data, function(index, tempObject) {
            var date = new Date(tempObject.time * 1000);
            var hours = date.getHours();
            var amPM = 'am';
            if(hours > 12){
              hours = hours - 12;
              amPM = 'pm'
            } else if(hours == 0) {
              hours = 12
            } else if(hours == 12){
              hours = 12
              amPM = 'pm'
            }
            $('#hourlyData').append('<section> \
              <h1>' + hours + ':00' + amPM +'</h1> \
              <ul> \
                <li>' + tempObject.summary + '</li> \
                <li>' + tempObject.temperature + '&deg;' + units + '</li> \
                <li>' + tempObject.precipProbability + '% chance of precipitation</li> \
              </ul> \
            </section>')
          })
        })
      }
      
      function geocodePosition(position) {
        geocoder = new google.maps.Geocoder();
        var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        geocoder.geocode({'latLng': latlng}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            if (results[1]) {
              $('h2').html(results[1].formatted_address)
            }
          } else {
            alert("Geocoder failed due to: " + status);
          }
        });
      }
      
      $(function(){
        getLocation();
        $('form').submit(function() {
          var address = $('#searchField').val();
          geocoder.geocode( { 'address': address}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              position = results[0].geometry.location;
              gotLocation(position.lb, position.mb);
              $('h2').html(results[0].formatted_address);
            } else {
              console.log("Geocode was not successful for the following reason: " + status);
              console.log(results);
            }
          });
          return false;
        });
        
        $('#currentLocation').click(function(e){
          getLocation();
          $('#searchField').val('');
          e.preventDefault();
        });
      });
    </script>
  </head>
  <body>
    <h1>Simple Weather</h1>
    <form>
      <input type="text" placeholder="Enter a location" id="searchField"/>
      <button type="submit">Search</button>
    </form>
    <button id="currentLocation">Current Location</button>
    <h2></h2>
    <section id="weatherSummary">
      <h1>Current Conditions</h1>
      <ul>
      </ul>
    </section>
    <section id="hourlyData">
    </section>
  </body>
</html>